# Руководство по расчёту прогноза

Этот документ описывает, как работает расчёт прогноза (`Model.estimate_forecast`) и
вспомогательные структуры вокруг `ForecastResult`. Здесь собраны ключевые
настройки, логика авто-подборов, примеры использования и структура выходных
метрик.

## Поток выполнения `Model.estimate_forecast`

1. **Подготовка данных.** Если передан `max_rows`, данные автоматически
   усекаются до последних `max_rows` строк. Факт усечения фиксируется в
   `result.preprocessing["rows"]` и в `result.notes`.
2. **Определение горизонта.** Аргумент `N` может быть числом или строкой
   (`"max"`, `"min"`). При автоматическом выборе горизонт ограничивается
   `max_auto_N`, чтобы предотвратить слишком длинные веера на больших задачах.
3. **Построение параметров расчёта.** Параметры собираются в
   `SSComputeParams`, куда пробрасываются `use_history`,
   `rolling_sample_pct`, `anchor_filter_len`, `max_auto_N`.
4. **Вызов `compute_forecast_ss`.** Возвращается `ForecastResult`, в который
   модель дописывает заметки и сведения о предобработке.

## Онлайн-логи расчёта

`compute_forecast_ss` печатает ключевые события по мере появления
(со сбросом буфера), поэтому ранние сообщения (размер окна, выбранный
горизонт, warm-up) видны сразу, ещё до завершения расчёта rolling.

* Размерность данных: `T`, количество CV/MV.
* Итоговый горизонт `N` и отметка об ограничении `max_auto_N`.
* Статус прогрева (warm-up).
* Настройки прореживания rolling: автоматические или ручные значения,
  ожидаемое число стартов и шаг.
* Количество реально посчитанных стартов и причина недоступности rolling.
* Прочие заметки (например, подробности авто-подбора) печатаются сразу
  после формирования.

## Эвристика `rolling_sample_pct`

При значении `None` доля стартов rolling подбирается автоматически с учётом
длины ряда (`T`), количества выходов (`n_cv`), входов (`n_mv`) и горизонта `N`.
Результат эвристики сохраняется в `result.preprocessing["rolling_sampling"]`
со следующими полями:

| Поле              | Описание                                                     |
|-------------------|--------------------------------------------------------------|
| `mode`            | `"auto"` или `"manual"`.                                     |
| `pct`             | Фактическая доля стартов в процентах.                         |
| `approx_starts`   | Ожидаемое число стартов по оценке.                            |
| `approx_step`     | Предполагаемый шаг между стартами.                            |
| `actual_starts`   | Сколько стартов реально посчитано.                            |
| `status`          | `"available"` / `"unavailable"`.                             |
| `reason`          | Причина недоступности (если rolling не считался).            |
| `T`, `n_cv`, `n_mv`, `N` | Параметры задачи (добавляются в авто-режиме).         |

## Структура `ForecastResult`

```python
result.df                       # исходные данные расчёта
result.mv_cols, result.cv_cols  # имена MV/CV
result.openloop_pred            # DataFrame с open-loop прогнозом
result.rolling_pred_by_horizon  # dict: горизонт -> DataFrame rolling-прогноза
result.N                        # глобальный горизонт
result.warmup_end_pos           # позиция окончания прогрева
result.rolling_available        # булев признак доступности rolling
result.notes                    # заметки (кап горизонта, эвристики и т.д.)
result.preprocessing            # сведения о подготовке и прореживании
```

Метрики можно получить программно через `metrics_dict()` или `to_dict()`:

```python
metrics = result.metrics_dict()
metrics["openloop"]["metrics_by_cv"]  # sMAPE/R² по каждой CV
metrics["rolling"]["metrics_per_horizon"]  # метрики по (горизонт, CV)
```

Метод `to_dict(include_predictions=True, include_source=True)` добавляет
исходные данные и предсказания в формате, пригодном для сериализации.

## Построение графиков

```python
result.plot_openloop(cv_list=["CV1", "CV3"], mv_list=["MV2"], max_points=1500)
result.plot_rolling(fan_stride=200, fan_max=15, cv_list=["CV1"], mv_list=["MV2", "MV4"])
```

* По умолчанию оба метода показывают последние `max_points` наблюдений и
  первые 5 CV/MV. Передача списков `cv_list`/`mv_list` позволяет явно выбрать
  переменные.
* Визуальные подсказки напоминают, что диапазон усечён или переменных больше 5.

## Текстовая сводка

`result.summary()` печатает краткий отчёт: размеры данных, горизонт и warm-up,
заметки, ключевые метрики (топ- и анти-топ CV) и усреднённые значения по
rolling. Можно получить строку, передав `return_text=True`.

## Пример полного сценария

```python
res = model.estimate_forecast(
    data=df,
    N="max",
    use_history=True,
    rolling_sample_pct=None,   # авто-эвристика
    anchor_filter_len=3,
    max_rows=10_000,
    max_auto_N=200,
)

res.summary()
print(res.metrics_dict())
res.plot_openloop()
res.plot_rolling(mv_list=["MV1", "MV4"], fan_stride=250)
res.to_json(include_predictions=True, indent=2)
```

Такой сценарий даёт поток логов, читаемую сводку, метрики в машинном виде и
интерактивные графики с управляемым набором CV/MV.
